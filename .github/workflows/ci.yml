name: ci

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  GO_VERSION: "1.23.x"
  PYTHON_VERSION: "3.12"

jobs:
  unit:
    name: unit (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # (optional) only if unit tests require these toolchains
      - name: Install pipx (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip pipx
          python -m pipx ensurepath || true
          pipx --version

      - name: Install pipx (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip pipx
          $pipxHome = "C:\pipx"
          $pipxBin  = "C:\pipx\bin"
          New-Item -ItemType Directory -Force -Path $pipxHome | Out-Null
          New-Item -ItemType Directory -Force -Path $pipxBin  | Out-Null
          "PIPX_HOME=$pipxHome" | Out-File -FilePath $env:GITHUB_ENV -Append
          "PIPX_BIN_DIR=$pipxBin" | Out-File -FilePath $env:GITHUB_ENV -Append
          Add-Content -Path $env:GITHUB_PATH -Value $pipxBin
          pipx --version

      - name: Go build (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          go build ./...

      - name: Go test (unit) (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          go test ./... -count=1 -v

      - name: Go build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          go build ./...

      - name: Go test (unit) (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          go test ./... -count=1 -v

  integration:
    name: integration (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    # If you ONLY want integration on manual runs, uncomment:
    # if: github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install pipx (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip pipx
          python -m pipx ensurepath || true
          pipx --version

      - name: Install pipx (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip pipx
          $pipxHome = "C:\pipx"
          $pipxBin  = "C:\pipx\bin"
          New-Item -ItemType Directory -Force -Path $pipxHome | Out-Null
          New-Item -ItemType Directory -Force -Path $pipxBin  | Out-Null
          "PIPX_HOME=$pipxHome" | Out-File -FilePath $env:GITHUB_ENV -Append
          "PIPX_BIN_DIR=$pipxBin" | Out-File -FilePath $env:GITHUB_ENV -Append
          Add-Content -Path $env:GITHUB_PATH -Value $pipxBin
          pipx --version

      - name: Ubuntu - ensure apt-get
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -e
          command -v apt-get
          sudo apt-get update

      - name: macOS - ensure Homebrew
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -e
          if ! command -v brew >/dev/null 2>&1; then
            /bin/bash -lc "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          if [ -x /opt/homebrew/bin/brew ]; then echo "/opt/homebrew/bin" >> "$GITHUB_PATH"; fi
          if [ -x /usr/local/bin/brew ]; then echo "/usr/local/bin" >> "$GITHUB_PATH"; fi
          brew --version

      - name: Windows - ensure Chocolatey
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          choco --version

      - name: Windows - ensure Scoop
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $scoopRoot  = Join-Path $env:USERPROFILE "scoop"
          $scoopShims = Join-Path $scoopRoot "shims"
          if (-not (Test-Path $scoopRoot)) {
            Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
            iwr -useb get.scoop.sh | iex
          }
          if (Test-Path $scoopShims) {
            Add-Content -Path $env:GITHUB_PATH -Value $scoopShims
            $env:PATH = "$scoopShims;$env:PATH"
          } else {
            throw "Scoop shims folder not found at: $scoopShims"
          }
          scoop --version

      - name: Windows - ensure WinGet
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-not (Get-Command winget -ErrorAction SilentlyContinue)) {
            throw "winget not found"
          }
          winget --version

      # ONLY integration tests:
      - name: Go test (integration) (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          go test -tags=integration ./pkgmanagers/managers -count=1 -v

      - name: Go test (integration) (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          go test -tags=integration ./pkgmanagers/managers -count=1 -v
