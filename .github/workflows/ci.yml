name: ci

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    env:
      GO_VERSION: "1.23.x"
      PYTHON_VERSION: "3.12"
      PKG_FORGE_IT: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install pipx (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip
          python -m pip install --upgrade pipx
          python -m pipx ensurepath || true
          pipx --version

      - name: Install pipx (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade pipx

          $pipxHome = "C:\pipx"
          $pipxBin  = "C:\pipx\bin"
          New-Item -ItemType Directory -Force -Path $pipxHome | Out-Null
          New-Item -ItemType Directory -Force -Path $pipxBin  | Out-Null

          "PIPX_HOME=$pipxHome" | Out-File -FilePath $env:GITHUB_ENV -Append
          "PIPX_BIN_DIR=$pipxBin" | Out-File -FilePath $env:GITHUB_ENV -Append
          Add-Content -Path $env:GITHUB_PATH -Value $pipxBin

          pipx --version

      - name: Ubuntu - ensure apt-get
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -e
          command -v apt-get
          sudo apt-get update

      - name: macOS - ensure Homebrew
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -e
          if ! command -v brew >/dev/null 2>&1; then
            echo "Homebrew missing, installing..."
            /bin/bash -lc "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            if [ -d /opt/homebrew/bin ]; then echo "/opt/homebrew/bin" >> "$GITHUB_PATH"; fi
            if [ -d /usr/local/bin ]; then echo "/usr/local/bin" >> "$GITHUB_PATH"; fi
          fi
          brew --version

      - name: Windows - ensure Chocolatey
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Write-Host "Chocolatey missing, installing..."
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          choco --version

      - name: Windows - ensure Scoop
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $scoopRoot  = Join-Path $env:USERPROFILE "scoop"
          $scoopShims = Join-Path $scoopRoot "shims"

          if (-not (Test-Path $scoopRoot)) {
            Write-Host "Scoop missing, installing..."
            Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
            iwr -useb get.scoop.sh | iex
          }

          if (Test-Path $scoopShims) {
            Add-Content -Path $env:GITHUB_PATH -Value $scoopShims
            $env:PATH = "$scoopShims;$env:PATH"
          } else {
            throw "Scoop shims folder not found at: $scoopShims"
          }

          scoop --version

      - name: Windows - ensure WinGet
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-not (Get-Command winget -ErrorAction SilentlyContinue)) {
            throw "winget not found (expected on windows-latest)."
          }
          winget --version

      - name: Verify toolchain (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          go version
          python --version
          python -m pip --version
          pipx --version
          cargo --version

      - name: Verify toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          go version
          python --version
          python -m pip --version
          pipx --version
          cargo --version
          choco --version
          scoop --version
          winget --version

      - name: Go build (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          go build ./...

      - name: Go test (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          go test ./... -count=1 -v

      - name: Go build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          go build ./...

      - name: Go test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          go test ./... -count=1 -v

      - name: Go test (integration) (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          go test -tags=integration ./... -count=1 -v

      - name: Go test (integration) (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          go test -tags=integration ./... -count=1 -v
